{% extends 'base.html' %}
{% load static %}
{% block title %}Predict Condition | PMA{% endblock %}
{% block content %}
<style>
:root {
  --brand-primary:#1e40af;
  --brand-accent:#3b82f6;
  --brand-bg:#f1f5f9;
  --panel-bg:#ffffff;
  --border:#e2e8f0;
  --radius-sm:6px;
  --radius:14px;
  --shadow-sm:0 2px 4px rgba(15,23,42,.06); 
  --shadow:0 4px 14px rgba(15,23,42,.08);
  --shadow-lg:0 12px 32px -4px rgba(15,23,42,.12);
  --danger:#dc2626;
  --success:#059669;
  --warn:#d97706;
  --info:#0284c7;
  font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
}

body.dark-mode .prediction-app {background:#0f172a;}

.prediction-app {max-width:1400px;margin:0 auto;padding:24px 24px 80px;}

.layout-grid {display:grid;grid-template-columns:260px 1fr 340px;gap:28px;align-items:start;}
@media (max-width:1250px){.layout-grid{grid-template-columns:220px 1fr 320px;}}
@media (max-width:1100px){.layout-grid{grid-template-columns:240px 1fr;}.summary-column{grid-column:1 / -1;order:3;}}
@media (max-width:820px){.layout-grid{grid-template-columns:1fr;}.nav-column{display:none;}.mobile-steps{display:flex;}}

/* Left Navigation */
.wizard-nav {background:var(--panel-bg);border:1px solid var(--border);border-radius:var(--radius);padding:18px 16px;position:sticky;top:88px;box-shadow:var(--shadow-sm);}
.wizard-nav h6 {font-size:.75rem;font-weight:600;letter-spacing:.08em;color:#64748b;margin:0 0 14px;text-transform:uppercase;}
.step-item {display:flex;align-items:center;gap:10px;padding:12px 10px;margin-bottom:4px;border-radius:10px;cursor:pointer;position:relative;transition:.18s ease;border:1px solid transparent;}
.step-item:hover {background:var(--brand-bg);}
.step-item.active {background:#eff6ff;border-color:#bfdbfe;}
.step-index {width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;border-radius:50%;background:#e2e8f0;color:#334155;flex-shrink:0;}
.step-item.active .step-index {background:var(--brand-primary);color:#fff;}
.step-label {font-size:.82rem;font-weight:600;color:#334155;line-height:1.1;}
.step-desc {display:block;font-size:.66rem;font-weight:500;color:#94a3b8;margin-top:2px;}
.step-item.complete .step-index {background:var(--success);color:#fff;}

.mobile-steps {display:none;margin-bottom:18px;gap:6px;}
.mobile-step-pill {flex:1;text-align:center;padding:10px 6px;font-size:.7rem;font-weight:600;border-radius:999px;border:1px solid var(--border);color:#475569;background:var(--panel-bg);}
.mobile-step-pill.active {background:var(--brand-primary);color:#fff;border-color:var(--brand-primary);}

/* Center Content */
.center-panel {background:var(--panel-bg);border:1px solid var(--border);border-radius:var(--radius);padding:32px 34px;box-shadow:var(--shadow);min-height:620px;position:relative;}
.center-panel h2 {margin:0 0 6px;font-size:1.65rem;font-weight:700;color:#0f172a;letter-spacing:-.5px;}
.center-panel>.section-intro {font-size:.9rem;color:#64748b;margin-bottom:28px;font-weight:500;}

.section {display:none;animation:fade .35s ease;}
.section.active {display:block;}
@keyframes fade {from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

.form-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:20px;margin-top:4px;}
.form-field label {display:block;font-size:.7rem;font-weight:700;letter-spacing:.09em;color:#475569;text-transform:uppercase;margin:0 0 6px;}
.form-field input,.form-field select {width:100%;border:1px solid var(--border);background:#f8fafc;padding:12px 14px;border-radius:10px;font-size:.85rem;font-weight:500;color:#0f172a;transition:.2s;border-bottom-width:2px;}
.form-field input:focus,.form-field select:focus {outline:none;background:#fff;border-color:var(--brand-primary);box-shadow:0 0 0 3px rgba(30,64,175,.15);} 
.inline-hint {font-size:.65rem;font-weight:500;color:#94a3b8;margin-top:4px;}

/* Symptom selection */
.category-filter-bar {display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 20px;}
.category-chip {padding:8px 14px;font-size:.7rem;font-weight:600;border-radius:30px;border:1px solid var(--border);background:#fff;color:#475569;cursor:pointer;transition:.18s;}
.category-chip:hover {background:#f1f5f9;}
.category-chip.active {background:var(--brand-primary);border-color:var(--brand-primary);color:#fff;}

.symptom-search-box {position:relative;margin-bottom:20px;}
.symptom-search-box input {width:100%;padding:14px 46px 14px 16px;border:1px solid var(--border);border-radius:12px;background:#f8fafc;font-size:.8rem;font-weight:500;}
.symptom-search-box input:focus {outline:none;background:#fff;border-color:var(--brand-primary);box-shadow:0 0 0 3px rgba(30,64,175,.15);}
.symptom-search-box i {position:absolute;right:16px;top:50%;transform:translateY(-50%);color:#64748b;font-size:.95rem;}

.symptom-groups {display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;max-height:420px;overflow:auto;padding-right:4px;}
.symptom-card {background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:10px 10px 12px;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;gap:4px;min-height:90px;position:relative;transition:.22s;}
.symptom-card:hover {background:#fff;border-color:#93c5fd;box-shadow:var(--shadow-sm);}
.symptom-card.selected {background:#1e3a8a;color:#fff;border-color:#1e3a8a;box-shadow:0 6px 18px -4px rgba(30,58,138,.45);}
.symptom-card .symptom-name {font-size:.72rem;font-weight:600;line-height:1.15;}
.symptom-card .symptom-cat {font-size:.55rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#64748b;}
.symptom-card.selected .symptom-cat {color:#bfdbfe;}

.selected-count-bar {display:flex;align-items:center;justify-content:space-between;margin:18px 0 6px;padding:10px 14px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;font-size:.7rem;font-weight:600;color:#1e40af;}
.clear-selected-btn {background:none;border:none;color:#dc2626;font-size:.65rem;font-weight:700;cursor:pointer;letter-spacing:.05em;}
.clear-selected-btn:hover {text-decoration:underline;}

/* Review Section */
.review-grid {display:grid;grid-template-columns:1fr 1fr;gap:26px;margin-top:10px;}
@media (max-width:900px){.review-grid{grid-template-columns:1fr;}}
.review-block {background:#f8fafc;border:1px solid var(--border);border-radius:16px;padding:20px 22px;position:relative;}
.review-block h4 {margin:0 0 10px;font-size:.78rem;font-weight:800;letter-spacing:.1em;color:#334155;text-transform:uppercase;}
.review-block ul {list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:8px;}
.token {background:#1e40af;color:#fff;padding:6px 10px;border-radius:999px;font-size:.63rem;font-weight:600;display:inline-flex;align-items:center;gap:4px;}
.token button {background:none;border:none;color:#bfdbfe;cursor:pointer;font-size:.7rem;}
.token button:hover {color:#fff;}

/* Right Summary */
.summary-column {position:sticky;top:88px;display:flex;flex-direction:column;gap:22px;}
.summary-panel {background:var(--panel-bg);border:1px solid var(--border);border-radius:var(--radius);padding:22px 22px 24px;box-shadow:var(--shadow);}
.summary-panel h3 {margin:0 0 14px;font-size:1rem;font-weight:700;color:#0f172a;letter-spacing:-.5px;}
.key-metric {display:flex;align-items:center;gap:14px;padding:12px 10px;border:1px solid var(--border);border-radius:14px;background:#f8fafc;}
.key-metric i {font-size:1.1rem;color:var(--brand-primary);}
.metric-label {font-size:.65rem;font-weight:700;letter-spacing:.08em;color:#475569;text-transform:uppercase;}
.metric-value {font-size:.9rem;font-weight:600;color:#0f172a;}

.recent-box {margin-top:8px;}
.recent-box h5 {margin:0 0 8px;font-size:.68rem;font-weight:700;letter-spacing:.08em;color:#475569;text-transform:uppercase;}
.recent-list {list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;}
.recent-item {font-size:.65rem;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#f8fafc;font-weight:500;display:flex;justify-content:space-between;gap:10px;}
.recent-item span {white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

.predict-box {margin-top:8px;display:flex;flex-direction:column;gap:14px;}
.primary-btn {background:linear-gradient(90deg,var(--brand-primary),var(--brand-accent));border:none;color:#fff;font-weight:700;font-size:.8rem;padding:14px 18px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;letter-spacing:.06em;box-shadow:0 4px 16px -2px rgba(30,64,175,.4);transition:.25s;}
.primary-btn:hover {transform:translateY(-2px);box-shadow:0 8px 26px -4px rgba(30,64,175,.5);}
.primary-btn:disabled {background:#94a3b8;cursor:not-allowed;box-shadow:none;}
.secondary-btn {background:#f1f5f9;border:1px solid var(--border);color:#334155;font-weight:600;font-size:.72rem;padding:11px 14px;border-radius:10px;cursor:pointer;}
.secondary-btn:hover {background:#e2e8f0;}

.divider-label {text-align:center;font-size:.6rem;font-weight:700;letter-spacing:.14em;color:#94a3b8;position:relative;margin:4px 0 2px;}
.divider-label:before,.divider-label:after {content:"";height:1px;background:var(--border);position:absolute;top:50%;width:38%;}
.divider-label:before {left:0;} .divider-label:after {right:0;}

/* Inline Result Card */
.prediction-result-wrapper {margin-top:38px;}
.prediction-result-card {display:none;background:#ffffff;border:1px solid var(--border);border-radius:18px;padding:28px 30px;box-shadow:var(--shadow-lg);position:relative;}
.prediction-result-card.loading:before {content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(255,255,255,0) 0%,rgba(241,245,249,.85) 45%,rgba(255,255,255,0) 90%);background-size:200% 100%;animation:shimmer 1.4s infinite;pointer-events:none;border-radius:18px;}
@keyframes shimmer {0%{background-position:200% 0}100%{background-position:-200% 0}}
.prediction-result-card.active {display:block;animation:fade .45s ease;}
.prediction-result-header {display:flex;align-items:center;gap:18px;margin-bottom:18px;flex-wrap:wrap;}
.prediction-disease {margin:0;font-size:1.55rem;font-weight:800;letter-spacing:-.5px;color:#0f172a;}
.prediction-meta-chip {background:#eff6ff;color:#1e3a8a;font-size:.58rem;padding:6px 10px;border-radius:999px;font-weight:700;letter-spacing:.08em;display:inline-flex;align-items:center;gap:6px;text-transform:uppercase;}
.confidence-bar {margin:6px 0 22px;height:14px;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;position:relative;overflow:hidden;}
.confidence-bar span {position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,var(--brand-primary),var(--brand-accent));width:0%;transition:width .9s cubic-bezier(.4,0,.2,1);}
.confidence-value-text {font-size:.75rem;font-weight:700;color:#1e3a8a;margin-top:-14px;text-align:right;}
.result-sections-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:24px;margin-top:10px;}
.result-box {background:#f8fafc;border:1px solid var(--border);border-radius:14px;padding:16px 18px;}
.result-box h5 {margin:0 0 10px;font-size:.68rem;letter-spacing:.11em;font-weight:800;color:#475569;text-transform:uppercase;}
.pill-list {list-style:none;margin:0;padding:0;display:flex;flex-wrap:wrap;gap:8px;}
.pill-list li {background:#1e40af;color:#fff;font-size:.58rem;font-weight:600;padding:6px 10px;border-radius:999px;letter-spacing:.05em;}
.raw-response {margin-top:22px;font-family:ui-monospace,monospace;background:#0f172a;color:#e2e8f0;font-size:.65rem;padding:14px 16px;border-radius:12px;max-height:180px;overflow:auto;line-height:1.35;}
.result-actions {margin-top:26px;display:flex;gap:12px;flex-wrap:wrap;}
.ghost-btn {background:#f1f5f9;border:1px solid var(--border);color:#334155;font-weight:600;font-size:.7rem;padding:10px 14px;border-radius:10px;cursor:pointer;}
.ghost-btn:hover {background:#e2e8f0;}
.danger-btn {background:#fee2e2;border:1px solid #fecaca;color:#b91c1c;font-weight:700;font-size:.7rem;padding:10px 14px;border-radius:10px;cursor:pointer;}
.danger-btn:hover {background:#fecaca;}

.fade-in {animation:fade .4s ease;}
.hidden {display:none !important;}
</style>

<div class="prediction-app" id="predictionAppRoot">
  <div class="mobile-steps" id="mobileSteps"></div>
  <div class="layout-grid">
    <!-- Left Navigation -->
    <aside class="nav-column">
      <nav class="wizard-nav" id="wizardNav">
        <h6>Prediction Flow</h6>
        <div class="step-item active" data-step="1">
          <div class="step-index">1</div>
          <div>
            <span class="step-label">Patient Profile</span>
            <span class="step-desc">Age & basic info</span>
          </div>
        </div>
        <div class="step-item" data-step="2">
          <div class="step-index">2</div>
          <div>
            <span class="step-label">Symptoms</span>
            <span class="step-desc">Select all that apply</span>
          </div>
        </div>
        <div class="step-item" data-step="3">
          <div class="step-index">3</div>
          <div>
            <span class="step-label">Review & Predict</span>
            <span class="step-desc">Confirm before run</span>
          </div>
        </div>
      </nav>
    </aside>

    <!-- Center Panel -->
    <main class="center-panel">
      <!-- Step 1 -->
      <section class="section active" data-step="1">
        <h2>Patient Information</h2>
        <p class="section-intro">Provide age and demographic details to improve model relevance.</p>
        <div class="form-grid">
          <div class="form-field">
            <label for="ageInput">Age</label>
            <input type="number" id="ageInput" min="1" max="120" placeholder="e.g. 34" />
            <div class="inline-hint">Required</div>
          </div>
          <div class="form-field">
            <label for="genderSelect">Gender</label>
            <select id="genderSelect">
              <option value="" disabled selected>Select</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
            <div class="inline-hint">Optional</div>
          </div>
        </div>
        <div style="margin-top:34px;display:flex;gap:14px;">
          <button class="primary-btn" id="toSymptomsBtn">Continue to Symptoms <i class="fas fa-arrow-right"></i></button>
        </div>
      </section>

      <!-- Step 2 -->
      <section class="section" data-step="2">
        <h2>Symptom Selection</h2>
        <p class="section-intro">Browse or filter by category. Click to add symptoms you currently experience.</p>
        <div class="category-filter-bar" id="categoryBar"></div>
        <div class="symptom-search-box">
          <input id="symptomSearch" type="text" placeholder="Search symptoms..." />
          <i class="fas fa-search"></i>
        </div>
        <div class="selected-count-bar" id="selectedCountBar" style="display:none;">
          <span><span id="selCount">0</span> symptoms selected</span>
          <button class="clear-selected-btn" id="clearSelectedBtn">CLEAR ALL</button>
        </div>
        <div class="symptom-groups" id="symptomGrid"></div>
        <div style="margin-top:30px;display:flex;gap:12px;">
          <button class="secondary-btn" data-prev>Back</button>
          <button class="primary-btn" data-next disabled id="toReviewBtn">Review & Continue <i class="fas fa-check-circle"></i></button>
        </div>
      </section>

      <!-- Step 3 -->
      <section class="section" data-step="3">
        <h2>Review & Predict</h2>
        <p class="section-intro">Confirm the information below, remove anything incorrect, then run prediction.</p>
        <div class="review-grid">
          <div class="review-block">
            <h4>Patient Profile</h4>
            <ul id="reviewProfile"></ul>
          </div>
          <div class="review-block">
            <h4>Selected Symptoms</h4>
            <ul id="reviewSymptoms"></ul>
          </div>
        </div>
        <div style="margin-top:34px;display:flex;gap:14px;">
          <button class="secondary-btn" data-prev>Back</button>
          <button class="primary-btn" id="runPredictionBtn" disabled>Run Prediction <i class="fas fa-microscope"></i></button>
        </div>
      </section>
    </main>

    <!-- Right Column Summary -->
    <aside class="summary-column">
      <div class="summary-panel">
        <h3>Session Overview</h3>
        <div class="key-metric"><i class="fas fa-user"></i><div><div class="metric-label">Age</div><div class="metric-value" id="ageMetric">-</div></div></div>
        <div class="key-metric"><i class="fas fa-venus-mars"></i><div><div class="metric-label">Gender</div><div class="metric-value" id="genderMetric">-</div></div></div>
        <div class="key-metric"><i class="fas fa-notes-medical"></i><div><div class="metric-label">Symptoms</div><div class="metric-value" id="symptomMetric">0 selected</div></div></div>
        <div class="divider-label">RECENT</div>
        <div class="recent-box">
          <h5>Recent Predictions</h5>
          <ul class="recent-list">
            {% for p in recent_predictions %}
              <li class="recent-item"><span>{{ p.predicted_disease }}</span><span>{{ p.created_at|date:'M d' }}</span></li>
            {% empty %}
              <li class="recent-item"><span>No history yet</span><span>-</span></li>
            {% endfor %}
          </ul>
        </div>
        <div class="predict-box">
          <button class="primary-btn" id="quickPredictBtn" disabled>Predict Now <i class="fas fa-bolt"></i></button>
          <button class="secondary-btn" id="resetAllBtn">Reset All</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Inline Prediction Result (Step 3) -->
<template id="resultTemplate">
  <div class="prediction-result-card" id="predictionResultCard">
    <div class="prediction-result-header">
      <h3 class="prediction-disease" id="resultDisease">—</h3>
      <div class="prediction-meta-chip"><i class="fas fa-shield-virus"></i> AI Prediction</div>
      <div id="resultSpinner" style="display:none;margin-left:auto;width:26px;height:26px;border:3px solid #e2e8f0;border-top-color:var(--brand-primary);border-radius:50%;animation:spin .85s linear infinite"></div>
    </div>
    <div class="confidence-bar"><span id="confidenceFill"></span></div>
    <div class="confidence-value-text" id="confidenceValue">0%</div>
    <div class="result-sections-grid">
      <div class="result-box">
        <h5>Medicine Plan</h5>
        <ul class="pill-list" id="medicineList"></ul>
      </div>
      <div class="result-box">
        <h5>Diet Recommendation</h5>
        <ul class="pill-list" id="dietList"></ul>
      </div>
    </div>
    <pre class="raw-response" id="rawResponseBox">Awaiting prediction...</pre>
    <div class="result-actions">
      <button class="ghost-btn" id="newPredictionBtn"><i class="fas fa-redo"></i> New Prediction</button>
      <button class="danger-btn" id="clearAllAfterResultBtn"><i class="fas fa-times-circle"></i> Clear All</button>
    </div>
  </div>
</template>

<script>
/*********************** DATA MODEL (Client) **************************/ 
const SYMPTOM_CATEGORIES = {
  Respiratory: ['cough','shortness of breath','wheezing','chest tightness','sore throat','runny nose','sneezing'],
  Gastrointestinal: ['abdominal pain','nausea','vomiting','diarrhea','constipation','heartburn','bloating'],
  Neurological: ['headache','dizziness','seizures','numbness','tingling','memory loss','confusion'],
  Skin: ['rash','itching','dry skin','redness','swelling','hives','bruising'],
  General: ['fever','fatigue','weight loss','chills','night sweats','weakness'],
  Musculoskeletal: ['joint pain','muscle pain','back pain','stiffness','swelling joints'],
  Urinary: ['painful urination','frequent urination','blood in urine','urgency','incontinence'],
  Mental: ['anxiety','depression','insomnia','mood swings','irritability']
};

// Flatten for search
const ALL_SYMPTOMS = Object.entries(SYMPTOM_CATEGORIES).flatMap(([cat,list]) => list.map(s => ({ name:s, category:cat })));

/*********************** STATE **************************/ 
let currentStep = 1;
let selectedSymptoms = new Set();
let ageValue = null;
let genderValue = null;

/*********************** HELPERS **************************/ 
const qs = (sel,p=document) => p.querySelector(sel);
const qsa = (sel,p=document) => [...p.querySelectorAll(sel)];
function updateNavState(){
  qsa('.step-item').forEach(el=>{el.classList.remove('active'); if(+el.dataset.step===currentStep){el.classList.add('active');}});
  qsa('.mobile-step-pill').forEach(el=>{el.classList.toggle('active', +el.dataset.step===currentStep)});
  qsa('.section').forEach(sec=>{sec.classList.toggle('active', +sec.dataset.step===currentStep)});
}

function buildMobilePills(){
  const bar = qs('#mobileSteps');
  bar.innerHTML = '';
  qsa('.step-item').forEach(step=>{
    const pill = document.createElement('div');
    pill.className='mobile-step-pill'+(step.classList.contains('active')?' active':'');
    pill.dataset.step=step.dataset.step;
    pill.textContent=step.querySelector('.step-label').textContent;
    pill.onclick=()=>{currentStep=+pill.dataset.step;updateNavState();};
    bar.appendChild(pill);
  });
}

function renderCategories(){
  const bar = qs('#categoryBar');
  bar.innerHTML = '<div class="category-chip active" data-cat="all">All</div>' + Object.keys(SYMPTOM_CATEGORIES).map(c=>`<div class="category-chip" data-cat="${c}">${c}</div>`).join('');
  bar.addEventListener('click',e=>{
    const chip = e.target.closest('.category-chip');
    if(!chip) return;
    qsa('.category-chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    filterSymptoms();
  });
}

function renderSymptoms(list=ALL_SYMPTOMS){
  const grid = qs('#symptomGrid');
  grid.innerHTML = '';
  list.forEach(item=>{
    const card=document.createElement('div');
    card.className='symptom-card'+(selectedSymptoms.has(item.name)?' selected':'');
    card.dataset.symptom=item.name;
    card.innerHTML = `<span class="symptom-cat">${item.category}</span><span class="symptom-name">${item.name}</span>`;
    card.onclick=()=>toggleSymptom(item.name,card);
    grid.appendChild(card);
  });
}

function filterSymptoms(){
  const activeCat = qs('.category-chip.active').dataset.cat;
  const term = qs('#symptomSearch').value.trim().toLowerCase();
  let filtered = ALL_SYMPTOMS.filter(s => !term || s.name.includes(term));
  if(activeCat!=='all'){filtered = filtered.filter(s=>s.category===activeCat);} 
  renderSymptoms(filtered);
}

function toggleSymptom(name,card){
  if(selectedSymptoms.has(name)){selectedSymptoms.delete(name);} else {selectedSymptoms.add(name);} 
  updateSelectedUI();
  if(card){card.classList.toggle('selected');}
}

function updateSelectedUI(){
  const count = selectedSymptoms.size;
  const bar = qs('#selectedCountBar');
  if(count>0){bar.style.display='flex'; qs('#selCount').textContent=count;} else {bar.style.display='none';}
  qs('#symptomMetric').textContent = count+ (count===1?' symptom':' symptoms');
  qs('#toReviewBtn').disabled = count===0;
  qs('#quickPredictBtn').disabled = count===0 || !ageValue;
}

function goToStep(step){currentStep=step;updateNavState();}

function buildReview(){
  const prof = qs('#reviewProfile');
  prof.innerHTML = '';
  prof.insertAdjacentHTML('beforeend', `<li class="token">Age: ${ageValue||'-'}</li>`);
  prof.insertAdjacentHTML('beforeend', `<li class="token">Gender: ${genderValue||'-'}</li>`);
  const sym = qs('#reviewSymptoms');
  sym.innerHTML = '';
  [...selectedSymptoms].forEach(s=>{
    const li=document.createElement('li');
    li.className='token';
    li.innerHTML = `${s} <button aria-label="Remove" data-rm="${s}">&times;</button>`;
    sym.appendChild(li);
  });
  sym.addEventListener('click',e=>{
    if(e.target.matches('button[data-rm]')){toggleSymptom(e.target.dataset.rm);buildReview();renderSymptoms();}
  },{once:true});
  qs('#runPredictionBtn').disabled = selectedSymptoms.size===0 || !ageValue;
}

function resetAll(){
  selectedSymptoms.clear();
  ageValue=null; genderValue=null;
  qs('#ageInput').value=''; qs('#genderSelect').value='';
  updateMetrics(); updateSelectedUI(); buildReview(); renderSymptoms();
  goToStep(1);
}

function updateMetrics(){
  qs('#ageMetric').textContent= ageValue||'-';
  qs('#genderMetric').textContent= genderValue||'-';
}

/*********************** PREDICTION **************************/ 
async function runPrediction(){
  const payload = {symptoms:[...selectedSymptoms], age:ageValue, gender:genderValue};
  const btn = qs('#runPredictionBtn');
  btn.disabled = true; btn.dataset.prevText = btn.textContent; btn.textContent='Predicting...';
  const card = ensureResultCard();
  card.classList.add('active','loading');
  qs('#resultSpinner').style.display='block';
  qs('#resultDisease').textContent='Running prediction...';
  qs('#confidenceFill').style.width='0%';
  qs('#confidenceValue').textContent='';
  qs('#medicineList').innerHTML='';
  qs('#dietList').innerHTML='';
  qs('#rawResponseBox').textContent='Waiting for model result...';
  try {
    const res = await fetch('{% url "patients:predict_disease_api" %}', {method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':getCSRFCookie()},body:JSON.stringify(payload)});
    const data = await res.json();
    showResult(data);
  } catch(err){
    showResult({error:'Prediction failed', detail: err.message});
  } finally {
    btn.disabled=false; btn.textContent=btn.dataset.prevText||'Run Prediction';
  }
}

function ensureResultCard(){
  let card = qs('#predictionResultCard');
  if(!card){
    const tpl = qs('#resultTemplate');
    const clone = tpl.content.cloneNode(true);
    // Insert after review-grid or at end of step 3 section
    const step3 = qs('.section[data-step="3"]');
    step3.appendChild(clone);
    card = qs('#predictionResultCard');
    // Hook action buttons
    qs('#newPredictionBtn').onclick=()=>{goToStep(2);};
    qs('#clearAllAfterResultBtn').onclick=()=>{resetAll();};
  }
  return card;
}

function showResult(data){
  const card = ensureResultCard();
  card.classList.add('active');
  card.classList.remove('loading');
  qs('#resultSpinner').style.display='none';
  const disease = data.predicted_disease||data.disease||data.error||'Unknown';
  qs('#resultDisease').textContent=disease;
  let rawConf = (data.confidence!==undefined?data.confidence:data.confidence_score)||0;
  if(rawConf<=1) rawConf = rawConf*100; // support 0-1 scale
  rawConf = Math.max(0, Math.min(100, rawConf));
  qs('#confidenceFill').style.width = rawConf+'%';
  qs('#confidenceValue').textContent = rawConf+'% Confidence';
  const meds = (data.medicine_recommendation||data.medicines||'').toString().split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  const diet = (data.diet_recommendation||data.diet||'').toString().split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  const medsList=qs('#medicineList'); medsList.innerHTML=''; meds.forEach(m=>medsList.insertAdjacentHTML('beforeend',`<li>${m}</li>`));
  const dietList=qs('#dietList'); dietList.innerHTML=''; diet.forEach(d=>dietList.insertAdjacentHTML('beforeend',`<li>${d}</li>`));
  qs('#rawResponseBox').textContent= JSON.stringify(data,null,2);
  card.scrollIntoView({behavior:'smooth', block:'start'});
}

/*********************** CSRF **************************/ 
function getCSRFCookie(){
  const name='csrftoken='; return document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(name))?.substring(name.length) || '';
}

/*********************** INIT **************************/ 
function init(){
  renderCategories();
  renderSymptoms();
  buildMobilePills();
  updateMetrics();
  updateSelectedUI();
  buildReview();

  // Nav click
  qs('#wizardNav').addEventListener('click',e=>{const step=e.target.closest('.step-item'); if(step){goToStep(+step.dataset.step);}});

  // Step 1 continue
  qs('#toSymptomsBtn').onclick=()=>{
    ageValue = parseInt(qs('#ageInput').value)||null;
    genderValue = qs('#genderSelect').value||null;
    updateMetrics();
    if(!ageValue){qs('#ageInput').focus();return;}
    goToStep(2);
  };

  // Back / Next buttons
  qsa('[data-prev]').forEach(btn=>btn.onclick=()=>{goToStep(Math.max(1,currentStep-1));});
  qsa('[data-next]').forEach(btn=>btn.onclick=()=>{if(currentStep===2){buildReview();} goToStep(Math.min(3,currentStep+1));});

  // Enable Review button when symptoms selected
  qs('#toReviewBtn').addEventListener('click',()=>{buildReview(); goToStep(3);});

  // Review run
  qs('#runPredictionBtn').onclick=()=>{ageValue = parseInt(qs('#ageInput').value)||ageValue; buildReview(); runPrediction();};
  qs('#quickPredictBtn').onclick=()=>{goToStep(3); buildReview(); runPrediction();};

  // Inputs sync
  qs('#ageInput').addEventListener('input',e=>{ageValue=parseInt(e.target.value)||null; updateMetrics(); updateSelectedUI();});
  qs('#genderSelect').addEventListener('change',e=>{genderValue=e.target.value||null; updateMetrics();});

  // Search + filter
  qs('#symptomSearch').addEventListener('input',filterSymptoms);
  qs('#clearSelectedBtn').onclick=()=>{selectedSymptoms.clear(); updateSelectedUI(); renderSymptoms(); buildReview();};

  // Reset all
  qs('#resetAllBtn').onclick=()=>{resetAll();};

  // (Drawer removed – inline card now)
}

document.addEventListener('DOMContentLoaded',init);
</script>
{% endblock %}
