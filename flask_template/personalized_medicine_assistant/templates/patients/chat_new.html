{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with Doctors - Patient Portal{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">
                        <i class="fas fa-comments text-primary me-2"></i>
                        Chat with Doctors
                    </h1>
                    <p class="text-muted mb-0">Communicate with your doctors from accepted appointments</p>
                </div>
                <a href="{% url 'patients:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0" style="height: calc(100vh - 200px);">
                <div class="card-body p-0 d-flex">
                    <!-- Left Sidebar - Doctor List -->
                    <div class="doctors-sidebar border-end" style="width: 350px; min-height: 100%;">
                        <div class="sidebar-header bg-primary text-white p-3">
                            <h5 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-user-md me-2"></i>
                                Available Doctors
                            </h5>
                        </div>
                        
                        <div class="doctors-list" style="height: calc(100% - 70px); overflow-y: auto;">
                            {% for appointment in accepted_appointments %}
                            <div class="doctor-item p-3 border-bottom cursor-pointer hover-bg-light" 
                                 data-doctor-id="{{ appointment.doctor.id }}"
                                 onclick="selectDoctor({{ appointment.doctor.id }}, '{{ appointment.doctor.user.get_full_name|default:appointment.doctor.user.username }}', '{{ appointment.doctor.specialization }}')">
                                <div class="d-flex align-items-center">
                                    <div class="doctor-avatar bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 45px; height: 45px;">
                                        <span class="text-white fw-bold">{{ appointment.doctor.user.first_name.0|default:appointment.doctor.user.username.0 }}</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 text-dark">Dr. {{ appointment.doctor.user.get_full_name|default:appointment.doctor.user.username }}</h6>
                                        <p class="text-muted small mb-0">{{ appointment.doctor.specialization }}</p>
                                        <p class="text-muted small mb-0">Last message preview...</p>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">10:30</small>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="p-4 text-center text-muted">
                                <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                <p class="mb-0">No accepted appointments found.<br>Book an appointment to start chatting with doctors.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Right Side - Chat Area -->
                    <div class="chat-area flex-grow-1 d-flex flex-column">
                        <!-- Chat Header -->
                        <div class="chat-header bg-light border-bottom p-3 d-flex justify-content-between align-items-center">
                            <div class="selected-doctor-info d-flex align-items-center">
                                <div class="doctor-avatar bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                     style="width: 40px; height: 40px;" id="chat-doctor-avatar">
                                    <span class="text-white fw-bold">?</span>
                                </div>
                                <div>
                                    <h6 class="mb-0" id="chat-doctor-name">Select a doctor to start chatting</h6>
                                    <small class="text-muted" id="chat-doctor-specialization">Choose from your accepted appointments</small>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button class="btn btn-outline-danger btn-sm me-2" id="clear-chat-btn" onclick="clearChat()" style="display: none;">
                                    <i class="fas fa-trash me-1"></i>
                                    Clear Chat
                                </button>
                                <button class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Messages Container -->
                        <div class="messages-container flex-grow-1 p-3" id="messages-container" style="overflow-y: auto; background-color: #f8f9fa;">
                            <div class="text-center text-muted py-5" id="no-chat-selected">
                                <i class="fas fa-comments fa-3x mb-3 text-secondary"></i>
                                <h5>Welcome to Patient Chat</h5>
                                <p>Select a doctor from the left to start a conversation.<br>You can only chat with doctors from your accepted appointments.</p>
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <div class="message-input-container border-top p-3 bg-white" id="message-input-area" style="display: none;">
                            <form id="message-form" class="d-flex align-items-center gap-2">
                                {% csrf_token %}
                                <div class="flex-grow-1">
                                    <input type="text" 
                                           class="form-control" 
                                           id="message-input" 
                                           placeholder="Type your message..."
                                           autocomplete="off"
                                           maxlength="1000">
                                </div>
                                <button type="submit" class="btn btn-primary" id="send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Full page chat styles */
    .hover-bg-light:hover {
        background-color: #f8f9fa !important;
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    .doctor-item.active {
        background-color: #e3f2fd !important;
        border-left: 4px solid #1976d2;
    }
    
    .doctors-sidebar {
        background: white;
        border-right: 1px solid #dee2e6;
    }
    
    .chat-area {
        background: white;
    }
    
    /* Messages */
    .message {
        margin-bottom: 1rem;
        display: flex;
        max-width: 70%;
        position: relative;
    }
    
    .message.sent {
        margin-left: auto;
        flex-direction: row-reverse;
    }
    
    .message.received {
        margin-right: auto;
    }
    
    .message-bubble {
        background: white;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.sent .message-bubble {
        background: #007bff;
        color: white;
        border: 1px solid #0056b3;
    }
    
    .message-text {
        line-height: 1.4;
        margin-bottom: 0.25rem;
    }
    
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .message-edited {
        font-style: italic;
        font-size: 0.65rem;
        opacity: 0.6;
    }
    
    .message-options {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .message:hover .message-options {
        opacity: 1;
    }
    
    .options-btn {
        background: rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        font-size: 0.7rem;
    }
    
    .message.received .options-btn {
        background: rgba(0, 0, 0, 0.1);
        color: #6c757d;
    }
    
    .options-menu {
        position: absolute;
        top: 30px;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 120px;
        display: none;
    }
    
    .options-menu.show {
        display: block;
    }
    
    .option-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        font-size: 0.8rem;
        color: #495057;
    }
    
    .option-item:last-child {
        border-bottom: none;
    }
    
    .option-item:hover {
        background-color: #f8f9fa;
    }
    
    .option-item.danger {
        color: #dc3545;
    }
    
    .option-item.danger:hover {
        background-color: #f8d7da;
    }
    
    /* Edit form */
    .edit-form {
        display: none;
    }
    
    .edit-form.active {
        display: block;
    }
    
    .edit-form input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .edit-form .btn-group {
        display: flex;
        gap: 0.5rem;
    }
    
    .edit-form .btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
    }
</style>

<!-- Clear Chat Confirmation Modal -->
<div class="modal fade" id="clearChatModal" tabindex="-1" aria-labelledby="clearChatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearChatModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Clear Chat History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear all chat history with <span id="clear-doctor-name"></span>?</p>
                <p class="text-muted small">This action cannot be undone and will remove all messages from this conversation.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-clear-chat">Clear Chat</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentDoctorId = null;

function selectDoctor(doctorId, doctorName, specialization) {
    currentDoctorId = doctorId;
    
    // Update active doctor in sidebar
    document.querySelectorAll('.doctor-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Update chat header
    const doctorAvatar = document.getElementById('chat-doctor-avatar');
    const doctorNameEl = document.getElementById('chat-doctor-name');
    const doctorSpecEl = document.getElementById('chat-doctor-specialization');
    
    doctorAvatar.innerHTML = `<span class="text-white fw-bold">${doctorName.charAt(0)}</span>`;
    doctorNameEl.textContent = `Dr. ${doctorName}`;
    doctorSpecEl.textContent = specialization;
    
    // Show message input area and clear chat button
    document.getElementById('message-input-area').style.display = 'block';
    document.getElementById('clear-chat-btn').style.display = 'inline-block';
    
    // Hide no chat selected message
    document.getElementById('no-chat-selected').style.display = 'none';
    
    // Load messages for this doctor
    loadMessages(doctorId);
}

function loadMessages(doctorId) {
    fetch(`/patients/chat/messages/${doctorId}/`)
        .then(response => response.json())
        .then(data => {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(message => {
                    addMessageToUI(
                        message.content, 
                        message.is_sent, 
                        message.created_at, 
                        message.created_date, 
                        message.id, 
                        message.is_edited, 
                        message.edit_count,
                        message.created_timestamp
                    );
                });
                
                // Start auto-updating timestamps
                startTimestampUpdates();
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Error loading messages. Please try again.</p>
                </div>
            `;
        });
}

// Handle message form submission
document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!currentDoctorId) return;
    
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    
    if (!messageText) return;
    
    // Add message to UI immediately with current timestamp
    const currentTime = new Date();
    const messageId = 'temp_' + Date.now(); // Temporary ID
    
    addMessageToUI(
        messageText, 
        true, 
        currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false }), 
        currentTime.toLocaleDateString('en-CA'),
        messageId,
        false,
        0,
        currentTime.toISOString()
    );
    
    // Clear input
    messageInput.value = '';
    
    // Send message to server
    sendMessage(currentDoctorId, messageText);
});

// Handle Enter key press in message input
document.getElementById('message-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('message-form').dispatchEvent(new Event('submit'));
    }
});

function addMessageToUI(text, isSent, time = null, date = null, messageId = null, isEdited = false, editCount = 0, timestamp = null) {
    const messagesContainer = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'} mb-3`;
    if (messageId) {
        messageDiv.setAttribute('data-message-id', messageId);
        if (timestamp) {
            messageDiv.setAttribute('data-timestamp', timestamp);
        }
    }
    
    // Convert timestamp to local time if available
    let timeDisplay = time;
    if (timestamp) {
        const localTime = new Date(timestamp);
        timeDisplay = localTime.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        });
        
        // Check if message is from a different date
        const localDate = localTime.toLocaleDateString('en-CA');
        const today = getCurrentDate();
        if (localDate !== today) {
            timeDisplay = `${localDate} ${timeDisplay}`;
        }
    } else {
        // Fallback to provided time or current time
        timeDisplay = time || getCurrentTime();
        if (date && date !== getCurrentDate()) {
            timeDisplay = `${date} ${timeDisplay}`;
        }
    }
    
    // Add edited indicator
    let editedText = '';
    if (isEdited && editCount > 0) {
        editedText = `<span class="message-edited ms-1">(edited)</span>`;
    }
    
    // Add relative time display
    let relativeTime = '';
    if (timestamp) {
        relativeTime = `<span class="relative-time ms-1 text-muted" data-timestamp="${timestamp}">${getRelativeTime(timestamp)}</span>`;
    }
    
    // Add options menu for sent messages
    let optionsMenu = '';
    if (isSent && messageId && !messageId.toString().startsWith('temp_')) {
        optionsMenu = `
            <div class="message-options">
                <button class="options-btn btn btn-sm" onclick="toggleOptions(${messageId})" type="button">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="options-menu" id="options-${messageId}">
                    <div class="option-item" onclick="editMessage(${messageId})">
                        <i class="fas fa-edit me-1"></i> Edit
                    </div>
                    <div class="option-item danger" onclick="deleteMessage(${messageId}, 'for_me')">
                        <i class="fas fa-trash me-1"></i> Delete for me
                    </div>
                    <div class="option-item danger" onclick="deleteMessage(${messageId}, 'for_everyone')">
                        <i class="fas fa-trash-alt me-1"></i> Delete for everyone
                    </div>
                </div>
            </div>
        `;
    }
    
    const bubbleClass = isSent ? 'bg-primary text-white ms-auto' : 'bg-light text-dark me-auto';
    
    messageDiv.innerHTML = `
        <div class="message-bubble ${bubbleClass} p-3 rounded-3 position-relative" style="max-width: 70%;">
            <div class="message-text" id="text-${messageId}">${text}</div>
            <div class="message-time small opacity-75 mt-1">
                <span class="exact-time">${timeDisplay}</span>
                ${relativeTime}
                ${editedText}
            </div>
            ${optionsMenu}
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
}

function getCurrentTimeWithSeconds() {
    const now = new Date();
    return now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
}

function getCurrentDate() {
    const now = new Date();
    return now.toLocaleDateString('en-CA'); // Returns YYYY-MM-DD format
}

function getRelativeTime(timestamp) {
    const now = new Date();
    const messageTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now - messageTime) / 1000);
    
    if (diffInSeconds < 60) {
        return diffInSeconds <= 5 ? 'just now' : `${diffInSeconds}s ago`;
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}m ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}h ago`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}d ago`;
    }
}

// Debug function to show timezone info
function debugTimestamp(timestamp) {
    if (timestamp) {
        const utcTime = new Date(timestamp);
        const localTime = new Date(timestamp);
        console.log('Debug Timestamp Info:');
        console.log('UTC Time:', utcTime.toISOString());
        console.log('Local Time:', localTime.toLocaleString());
        console.log('Local Time (24h):', localTime.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        }));
        console.log('Timezone Offset (minutes):', localTime.getTimezoneOffset());
    }
}

let timestampUpdateInterval;

function startTimestampUpdates() {
    // Clear any existing interval
    if (timestampUpdateInterval) {
        clearInterval(timestampUpdateInterval);
    }
    
    // Update relative timestamps every 30 seconds
    timestampUpdateInterval = setInterval(updateRelativeTimestamps, 30000);
}

function updateRelativeTimestamps() {
    const relativeTimeElements = document.querySelectorAll('.relative-time');
    relativeTimeElements.forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        if (timestamp) {
            element.textContent = getRelativeTime(timestamp);
        }
    });
}

function sendMessage(doctorId, messageText) {
    // Send message via AJAX
    fetch('/patients/chat/send/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            doctor_id: doctorId,
            content: messageText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Message sent successfully');
            
            // Replace the temporary message with the real one from server
            const tempMessages = document.querySelectorAll('[data-message-id^="temp_"]');
            if (tempMessages.length > 0) {
                const lastTempMessage = tempMessages[tempMessages.length - 1];
                
                // Update the message ID and timestamp
                lastTempMessage.setAttribute('data-message-id', data.message.id);
                lastTempMessage.setAttribute('data-timestamp', data.message.created_timestamp);
                
                // Update the time display with server timestamp converted to local time
                const timeElement = lastTempMessage.querySelector('.exact-time');
                if (timeElement && data.message.created_timestamp) {
                    const serverTime = new Date(data.message.created_timestamp);
                    const localTimeDisplay = serverTime.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    });
                    timeElement.textContent = localTimeDisplay;
                }
                
                // Add relative time
                const messageTimeDiv = lastTempMessage.querySelector('.message-time');
                if (messageTimeDiv && data.message.created_timestamp) {
                    const relativeTime = messageTimeDiv.querySelector('.relative-time');
                    if (!relativeTime) {
                        const relativeSpan = document.createElement('span');
                        relativeSpan.className = 'relative-time ms-1 text-muted';
                        relativeSpan.setAttribute('data-timestamp', data.message.created_timestamp);
                        relativeSpan.textContent = getRelativeTime(data.message.created_timestamp);
                        messageTimeDiv.appendChild(relativeSpan);
                    }
                }
                
                // Add options menu since we now have a real message ID
                const messageBubble = lastTempMessage.querySelector('.message-bubble');
                if (messageBubble && !messageBubble.querySelector('.message-options')) {
                    const optionsMenu = document.createElement('div');
                    optionsMenu.className = 'message-options';
                    optionsMenu.innerHTML = `
                        <button class="options-btn btn btn-sm" onclick="toggleOptions(${data.message.id})" type="button">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="options-menu" id="options-${data.message.id}">
                            <div class="option-item" onclick="editMessage(${data.message.id})">
                                <i class="fas fa-edit me-1"></i> Edit
                            </div>
                            <div class="option-item danger" onclick="deleteMessage(${data.message.id}, 'for_me')">
                                <i class="fas fa-trash me-1"></i> Delete for me
                            </div>
                            <div class="option-item danger" onclick="deleteMessage(${data.message.id}, 'for_everyone')">
                                <i class="fas fa-trash-alt me-1"></i> Delete for everyone
                            </div>
                        </div>
                    `;
                    messageBubble.appendChild(optionsMenu);
                }
            }
            
        } else {
            console.error('Error sending message:', data.error);
            alert('Failed to send message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Message options functions
function toggleOptions(messageId) {
    const menu = document.getElementById(`options-${messageId}`);
    const allMenus = document.querySelectorAll('.options-menu');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m !== menu) m.classList.remove('show');
    });
    
    // Toggle current menu
    menu.classList.toggle('show');
}

// Close menus when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.message-options')) {
        document.querySelectorAll('.options-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

function editMessage(messageId) {
    const textElement = document.getElementById(`text-${messageId}`);
    const currentText = textElement.textContent;
    
    // Create edit form
    const editForm = document.createElement('div');
    editForm.className = 'edit-form active';
    editForm.innerHTML = `
        <input type="text" value="${currentText}" class="form-control form-control-sm mb-2" id="edit-input-${messageId}">
        <div class="btn-group">
            <button class="btn btn-primary btn-sm" onclick="saveEdit(${messageId})">Save</button>
            <button class="btn btn-secondary btn-sm" onclick="cancelEdit(${messageId})">Cancel</button>
        </div>
    `;
    
    // Replace text with form
    textElement.innerHTML = '';
    textElement.appendChild(editForm);
    
    // Focus input
    document.getElementById(`edit-input-${messageId}`).focus();
    
    // Close options menu
    document.getElementById(`options-${messageId}`).classList.remove('show');
}

function saveEdit(messageId) {
    const input = document.getElementById(`edit-input-${messageId}`);
    const newText = input.value.trim();
    const textElement = document.getElementById(`text-${messageId}`);
    
    if (!newText) {
        alert('Message cannot be empty');
        return;
    }
    
    // Send edit request
    fetch(`/patients/chat/edit/${messageId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            content: newText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            textElement.textContent = newText;
            // Update time display to show edited status
            const timeElement = textElement.parentElement.querySelector('.message-time');
            if (!timeElement.innerHTML.includes('(edited)')) {
                timeElement.innerHTML += ' <span class="message-edited">(edited)</span>';
            }
        } else {
            alert('Failed to edit message: ' + data.error);
            cancelEdit(messageId);
        }
    })
    .catch(error => {
        console.error('Error editing message:', error);
        alert('Failed to edit message. Please try again.');
        cancelEdit(messageId);
    });
}

function cancelEdit(messageId) {
    const textElement = document.getElementById(`text-${messageId}`);
    const originalText = textElement.querySelector('input').defaultValue;
    textElement.textContent = originalText;
}

function deleteMessage(messageId, deleteType) {
    const confirmMsg = deleteType === 'for_everyone' 
        ? 'Are you sure you want to delete this message for everyone? This cannot be undone.'
        : 'Are you sure you want to delete this message for yourself?';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    fetch(`/patients/chat/delete/${messageId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            delete_type: deleteType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (deleteType === 'for_everyone') {
                // Update message content to show it was deleted
                const textElement = messageElement.querySelector('.message-text');
                textElement.textContent = 'This message was deleted';
                textElement.style.fontStyle = 'italic';
                textElement.style.opacity = '0.6';
                // Remove options menu
                const options = messageElement.querySelector('.message-options');
                if (options) options.remove();
            } else {
                // Remove message from UI
                messageElement.remove();
            }
        } else {
            alert('Failed to delete message: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting message:', error);
        alert('Failed to delete message. Please try again.');
    });
    
    // Close options menu
    document.getElementById(`options-${messageId}`).classList.remove('show');
}

function clearChat() {
    if (!currentDoctorId) {
        alert('Please select a doctor first.');
        return;
    }
    
    // Show Bootstrap modal
    const clearDoctorName = document.getElementById('chat-doctor-name').textContent;
    document.getElementById('clear-doctor-name').textContent = clearDoctorName;
    
    const modal = new bootstrap.Modal(document.getElementById('clearChatModal'));
    modal.show();
}

// Handle confirm clear chat
document.getElementById('confirm-clear-chat').addEventListener('click', function() {
    fetch(`/patients/chat/clear/${currentDoctorId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear messages from UI
            document.getElementById('messages-container').innerHTML = '';
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('clearChatModal'));
            modal.hide();
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show';
            successDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Chat cleared successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(successDiv, document.querySelector('.row').nextSibling);
            
            // Auto dismiss after 3 seconds
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        } else {
            alert('Failed to clear chat: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error clearing chat:', error);
        alert('Failed to clear chat. Please try again.');
    });
});

// Handle page visibility changes for performance optimization
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden, stop timestamp updates
        if (timestampUpdateInterval) {
            clearInterval(timestampUpdateInterval);
        }
    } else {
        // Page is visible, restart timestamp updates if there are messages
        const messagesContainer = document.getElementById('messages-container');
        if (messagesContainer && messagesContainer.children.length > 0) {
            startTimestampUpdates();
            // Update immediately when page becomes visible
            updateRelativeTimestamps();
        }
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (timestampUpdateInterval) {
        clearInterval(timestampUpdateInterval);
    }
});

// Start timestamp updates when page loads if there are existing messages
document.addEventListener('DOMContentLoaded', function() {
    // Check if there are any messages already loaded
    setTimeout(() => {
        const messagesContainer = document.getElementById('messages-container');
        if (messagesContainer && messagesContainer.children.length > 0) {
            startTimestampUpdates();
        }
    }, 1000);
});
</script>

{% endblock %}