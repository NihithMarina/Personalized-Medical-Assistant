
{% extends 'base.html' %}
{% load static %}
{% block title %}Patient Dashboard - PMA{% endblock %}

{% block content %}
<style>
    .dashboard-section {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(16,24,40,0.06);
        padding: 28px 22px;
        margin-bottom: 28px;
    }
    .dashboard-header {
        font-size: 2.25rem;
        font-weight: 800;
        color: #1e40af;
        margin: 0;
        text-align: left;
        line-height: 1.05;
        letter-spacing: -0.4px;
    }
    .header-row { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: 6px; 
        padding-left: 12px; 
    }
    .header-left {
        display: flex;
        align-items: center;
        gap: 18px;
    }
    /* patient icon in header */
    .header-icon { 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        width: 44px; 
        height: 44px; 
        border-radius: 10px; 
        background: linear-gradient(135deg,#eef2ff 0%, #ffffff 100%); 
        box-shadow: 0 4px 12px rgba(16,24,40,0.04); 
        color: #1e40af; 
        font-size: 20px; 
    }
    .dashboard-subtitle { 
        text-align: left; 
        color: #6b7280; 
        margin-top: 6px; 
        font-size: 0.95rem; 
    }
    .header-date {
        text-align: right;
        color: #6b7280;
        font-size: 0.9rem;
    }
    .date-label {
        display: block;
        font-size: 0.8rem;
        opacity: 0.7;
        margin-bottom: 4px;
    }
    .current-date {
        font-weight: 600;
        color: #1e40af;
    }

    /* Statistics Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
        margin-bottom: 28px;
    }
    .stat-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 18px rgba(16,24,40,0.04);
        padding: 22px;
        display: flex;
        align-items: center;
        gap: 16px;
        border: 1px solid #f1f5f9;
        transition: transform 0.12s;
    }
    .stat-card:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 6px 25px rgba(16,24,40,0.08);
    }
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
    }
    .stat-card.predictions .stat-icon {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
    }
    .stat-card.appointments .stat-icon {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #059669;
    }
    .stat-card.reminders .stat-icon {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #d97706;
    }
    .stat-card.bmi .stat-icon {
        background: linear-gradient(135deg, #cffafe 0%, #a7f3d0 100%);
        color: #0891b2;
    }
    .stat-content h3 {
        margin: 0 0 4px 0;
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 4px;
        line-height: 1;
    }
    .stat-status {
        font-size: 1.2rem;
        font-weight: 600;
        color: #0891b2;
        margin-bottom: 4px;
        line-height: 1;
        text-transform: capitalize;
    }
    .stat-label {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }

    /* Action Cards */
    .dashboard-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
        align-items: stretch;
        margin-bottom: 28px;
    }
    .dashboard-card {
        background: #4f46e5;
        color: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.15);
        padding: 22px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        min-height: 140px;
        position: relative;
        overflow: hidden;
        transition: transform 0.12s;
        text-decoration: none;
    }
    .dashboard-card:hover { 
        transform: translateY(-6px); 
        text-decoration: none;
        color: #fff;
    }
    .dashboard-card .icon { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        width: 48px; 
        height: 48px; 
        border-radius: 50%; 
        background: rgba(255,255,255,0.12); 
        font-size: 22px; 
        margin-bottom: 12px; 
    }
    .dashboard-card .card-title { 
        font-size: 1.15rem; 
        font-weight: 700; 
        margin-bottom: 6px; 
    }
    .dashboard-card .card-text { 
        font-size: 0.97rem; 
        margin-bottom: 12px; 
        opacity: 0.95; 
    }
    .dashboard-card .btn { 
        background: #fff; 
        color: #1e40af; 
        font-weight: 700; 
        border-radius: 8px; 
        padding: 8px 16px; 
        box-shadow: 0 2px 8px rgba(16,24,40,0.06); 
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.12s;
    }
    .dashboard-card .btn:hover { 
        background: #1e40af; 
        color: #fff; 
    }

    /* Content Sections */
    .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 28px;
    }
    .content-section {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 6px 30px rgba(16,24,40,0.06);
        padding: 28px 22px;
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f1f5f9;
    }
    .section-header h2 {
        margin: 0;
        font-size: 1.3rem;
        color: #1e40af;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .section-header h2 i {
        color: #2d6cdf;
        font-size: 1.1rem;
    }
    .view-all-btn {
        background: #eef2ff;
        color: #1e40af;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.12s;
    }
    .view-all-btn:hover {
        background: #1e40af;
        color: white;
        text-decoration: none;
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .clear-all-btn {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.12s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .clear-all-btn:hover {
        background: #dc2626;
        color: white;
        border-color: #dc2626;
    }
    
    .clear-all-btn i {
        font-size: 0.9rem;
    }

    /* Lists */
    .predictions-list, .appointments-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .prediction-item, .appointment-item {
        padding: 16px;
        border-radius: 8px;
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        transition: all 0.12s;
    }
    .prediction-item:hover {
        background: #eef2ff;
        border-color: #dbeafe;
    }
    .appointment-item:hover {
        background: #dcfce7;
        border-color: #bbf7d0;
    }
    .prediction-info h4, .appointment-info h4 {
        margin: 0 0 8px 0;
        font-size: 1rem;
        color: #1e293b;
        font-weight: 600;
    }
    .prediction-details, .appointment-details {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 0.85rem;
        color: #64748b;
    }
    .prediction-date, .appointment-date {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .confidence-badge {
        background: #1e40af;
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .appointment-time {
        background: #f1f5f9;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #475569;
    }
    .status-badge {
        background: #059669;
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-badge.status-pending {
        background: #f59e0b;
        color: white;
    }
    
    .status-badge.status-accepted {
        background: #059669;
        color: white;
    }
    
    .status-badge.status-completed {
        background: #10b981;
        color: white;
    }
    
    .status-badge.status-rejected {
        background: #ef4444;
        color: white;
    }
    
    .status-badge.status-cancelled {
        background: #6b7280;
        color: white;
    }
    
    .appointment-actions {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f1f5f9;
    }
    
    .message-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #1e40af;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .message-btn:hover {
        background: #1e3a8a;
        transform: translateY(-1px);
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }
    
    .view-summary-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .view-summary-btn:hover {
        transform: translateY(-1px);
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: #94a3b8;
    }
    .empty-state i {
        font-size: 2.5rem;
        color: #cbd5e1;
        margin-bottom: 12px;
        display: block;
    }
    .empty-state p {
        margin: 0;
        font-size: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
        .header-date {
            text-align: left;
            align-self: stretch;
        }
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }
        .dashboard-cards {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .dashboard-cards {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Main Dashboard Section -->
<div class="dashboard-section">
    <div class="header-row">
        <div class="header-left">
            <div class="header-icon"><i class='bx bx-user-circle'></i></div>
            <div>
                <div class="dashboard-header">Patient Dashboard</div>
                <div class="dashboard-subtitle">Welcome back, {{ profile.full_name|default:user.first_name|default:user.username }}! Manage your health and medical records from one place</div>
            </div>
        </div>
        <div class="header-date">
            <div class="date-label">Today's Date</div>
            <div class="current-date" id="current-date"></div>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card predictions">
            <div class="stat-icon">
                <i class='bx bx-brain'></i>
            </div>
            <div class="stat-content">
                <h3>Predictions</h3>
                <div class="stat-number">{{ total_predictions }}</div>
                <span class="stat-label">Total</span>
            </div>
        </div>
        
        <div class="stat-card appointments">
            <div class="stat-icon">
                <i class='bx bx-calendar-check'></i>
            </div>
            <div class="stat-content">
                <h3>Appointments</h3>
                <div class="stat-number">{{ upcoming_appointments|length }}</div>
                <span class="stat-label">Upcoming</span>
            </div>
        </div>
        
        <div class="stat-card reminders">
            <div class="stat-icon">
                <i class='bx bx-bell'></i>
            </div>
            <div class="stat-content">
                <h3>Active Reminders</h3>
                <div class="stat-number">{{ active_reminders|length }}</div>
                <span class="stat-label">Reminders</span>
            </div>
        </div>
        
        <div class="stat-card bmi">
            <div class="stat-icon">
                <i class='bx bx-heart'></i>
            </div>
            <div class="stat-content">
                <h3>BMI Status</h3>
                <div class="stat-status">{{ profile.bmi_status|default:"underweight" }}</div>
                <span class="stat-label">Health</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="dashboard-cards">
        <a href="{% url 'patients:disease_prediction' %}" class="dashboard-card" style="background: #4f46e5;">
            <div class="icon"><i class='bx bx-brain'></i></div>
            <div class="card-title">Predict Disease</div>
            <div class="card-text">Utilize AI predictions for personalized health insights.</div>
            <span class="btn">Start Prediction</span>
        </a>
        
        <a href="{% url 'patients:book_appointment' %}" class="dashboard-card" style="background: #059669;">
            <div class="icon"><i class='bx bx-calendar-plus'></i></div>
            <div class="card-title">Book Appointment</div>
            <div class="card-text">Schedule appointments with healthcare professionals.</div>
            <span class="btn">Book Now</span>
        </a>
        
        <a href="{% url 'patients:chat' %}" class="dashboard-card" style="background: #0ea5e9;">
            <div class="icon"><i class='bx bx-chat'></i></div>
            <div class="card-title">Chat with Doctors</div>
            <div class="card-text">Message doctors from your accepted appointments.</div>
            <span class="btn">Open Chat</span>
        </a>
        
        <a href="{% url 'patients:add_medicine_reminder' %}" class="dashboard-card" style="background: #dc2626;">
            <div class="icon"><i class='bx bx-bell-plus'></i></div>
            <div class="card-title">Add Reminder</div>
            <div class="card-text">Set medication reminders and health alerts.</div>
            <span class="btn">Add Reminder</span>
        </a>
        
        <a href="{% url 'patients:medical_records' %}" class="dashboard-card" style="background: #7c3aed;">
            <div class="icon"><i class='bx bx-folder-open'></i></div>
            <div class="card-title">Medical Records</div>
            <div class="card-text">Access and manage your medical documents.</div>
            <span class="btn">View Records</span>
        </a>
    </div>
</div>

<!-- Content Grid -->
<div class="content-grid">
    <!-- Recent Predictions -->
    <div class="content-section">
        <div class="section-header">
            <h2><i class='bx bx-brain'></i> Recent Predictions</h2>
            <div class="header-actions">
                <a href="{% url 'patients:disease_prediction' %}" class="view-all-btn">View all predictions →</a>
                {% if total_predictions > 0 %}
                <button onclick="clearAllPredictions()" class="clear-all-btn">
                    <i class='bx bx-trash'></i> Clear All
                </button>
                {% endif %}
            </div>
        </div>
        <div class="section-content">
            {% if recent_predictions %}
                <div class="predictions-list">
                    {% for prediction in recent_predictions %}
                    <div class="prediction-item">
                        <div class="prediction-info">
                            <h4>{{ prediction.predicted_disease }}</h4>
                            <div class="prediction-details">
                                <span class="prediction-date">
                                    <i class='bx bx-calendar'></i>
                                    {{ prediction.created_at|date:"M d, Y" }}
                                </span>
                                <span class="confidence-badge">
                                    Confidence: {{ prediction.confidence_score }}%
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class='bx bx-brain'></i>
                    <p>No predictions yet. Try the AI model.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Upcoming Appointments -->
    <div class="content-section">
        <div class="section-header">
            <h2><i class='bx bx-calendar-check'></i> Upcoming Appointments</h2>
            <a href="{% url 'patients:book_appointment' %}" class="view-all-btn">Book appointment →</a>
        </div>
        <div class="section-content">
            {% if upcoming_appointments %}
                <div class="appointments-list">
                    {% for appointment in upcoming_appointments %}
                    <div class="appointment-item">
                        <div class="appointment-info">
                            <h4>
                                {% if appointment.doctor.full_name %}
                                    Dr. {{ appointment.doctor.full_name }}
                                {% else %}
                                    Dr. {{ appointment.doctor.user.first_name }} {{ appointment.doctor.user.last_name }}
                                {% endif %}
                            </h4>
                            <div class="appointment-details">
                                <span class="appointment-date">
                                    <i class='bx bx-calendar'></i>
                                    {{ appointment.appointment_date|date:"M d, Y" }}
                                </span>
                                <span class="appointment-time">{{ appointment.appointment_time|time:"g:i A" }}</span>
                                <span class="status-badge status-{{ appointment.status }}">{{ appointment.get_status_display }}</span>
                            </div>
                            {% if appointment.status == 'accepted' %}
                            <div class="appointment-actions">
                                <a href="{% url 'patients:chat' %}?doctor={{ appointment.doctor.id }}" class="message-btn">
                                    <i class='bx bx-chat'></i> Chat with Doctor
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class='bx bx-calendar-check'></i>
                    <p>No upcoming appointments. Schedule one.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent Medical Summaries -->
    <div class="content-section">
        <div class="section-header">
            <h2><i class='bx bx-file-doc'></i> Recent Medical Summaries</h2>
            <a href="{% url 'patients:appointments' %}" class="view-all-btn">View all appointments →</a>
        </div>
        <div class="section-content">
            {% if completed_appointments %}
                <div class="appointments-list">
                    {% for appointment in completed_appointments %}
                    <div class="appointment-item completed">
                        <div class="appointment-info">
                            <h4>
                                {% if appointment.doctor.full_name %}
                                    Dr. {{ appointment.doctor.full_name }}
                                {% else %}
                                    Dr. {{ appointment.doctor.user.first_name }} {{ appointment.doctor.user.last_name }}
                                {% endif %}
                            </h4>
                            <div class="appointment-details">
                                <span class="appointment-date">
                                    <i class='bx bx-calendar'></i>
                                    {{ appointment.appointment_date|date:"M d, Y" }}
                                </span>
                                <span class="appointment-time">{{ appointment.appointment_time|time:"g:i A" }}</span>
                                <span class="status-badge status-completed">
                                    <i class='bx bx-check-circle'></i> Completed
                                </span>
                            </div>
                            <div class="appointment-actions">
                                <a href="{% url 'patients:appointment_details' appointment.id %}" class="view-summary-btn">
                                    <i class='bx bx-file-doc'></i> View Medical Summary
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class='bx bx-file-doc'></i>
                    <p>No completed appointments yet. Medical summaries will appear here after your appointments.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Update current date
document.addEventListener('DOMContentLoaded', function() {
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
        const now = new Date();
        const options = { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        };
        dateElement.textContent = now.toLocaleDateString('en-US', options);
    }
});

// Clear all predictions function
function clearAllPredictions() {
    if (!confirm('Are you sure you want to clear ALL prediction history? This action cannot be undone.')) {
        return;
    }
    
    fetch('{% url "patients:clear_all_predictions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(`Successfully cleared ${data.deleted_count} predictions!`);
            // Reload the page to update the UI
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to clear predictions'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while clearing predictions');
    });
}

// Get CSRF token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}