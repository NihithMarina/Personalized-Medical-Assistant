{% extends 'base.html' %}
{% load static %}

{% block title %}Disease Prediction - PMA{% endblock %}

{% block content %}
<style>
    /* Override base template padding for full-width layout */
    main {
        padding: 0 !important;
    }
    
    /* Simple and Clean Disease Prediction Styles */
    .prediction-container {
        width: 100%;
        margin: 0;
        padding: 0;
        background: #f8fafc;
        min-height: 100vh;
    }

    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 20px;
        text-align: center;
    }

    .hero-section h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0 0 16px 0;
    }

    .hero-section p {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
    }

    .wizard-container {
        max-width: 800px;
        margin: -30px auto 40px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* Progress Steps */
    .progress-steps {
        display: flex;
        background: #f1f5f9;
        padding: 0;
    }

    .step {
        flex: 1;
        padding: 20px;
        text-align: center;
        position: relative;
        background: #e2e8f0;
        color: #64748b;
        font-weight: 600;
        transition: all 0.3s;
    }

    .step.active {
        background: #3b82f6;
        color: white;
    }

    .step.completed {
        background: #10b981;
        color: white;
    }

    .step-number {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        line-height: 30px;
        margin-bottom: 8px;
        font-weight: 700;
    }

    .step.active .step-number,
    .step.completed .step-number {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Step Content */
    .step-content {
        display: none;
        padding: 40px;
        min-height: 400px;
    }

    .step-content.active {
        display: block;
    }

    .step-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
        text-align: center;
    }

    .step-description {
        color: #64748b;
        text-align: center;
        margin-bottom: 30px;
        font-size: 1.1rem;
    }

    /* Simple Symptom Selection */
    .symptom-search {
        position: relative;
        margin-bottom: 30px;
    }

    .symptom-search input {
        width: 100%;
        padding: 16px 20px 16px 50px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        background: #f8fafc;
    }

    .symptom-search input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
    }

    .symptom-search i {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        font-size: 1.2rem;
    }

    .common-symptoms {
        margin-bottom: 30px;
    }

    .common-symptoms h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
    }

    .symptom-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
    }

    .symptom-card {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
    }

    .symptom-card:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .symptom-card.selected {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
    }

    .symptom-icon {
        font-size: 2rem;
        margin-bottom: 8px;
        display: block;
    }

    .symptom-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .symptom-description {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .selected-symptoms {
        margin-top: 30px;
        padding: 20px;
        background: #f0f9ff;
        border-radius: 12px;
        border: 1px solid #0ea5e9;
        display: none;
    }

    .selected-symptoms.show {
        display: block;
    }

    .selected-symptoms h3 {
        color: #0c4a6e;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .selected-item {
        background: #0ea5e9;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .selected-item .remove {
        cursor: pointer;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
    }

    /* Navigation Buttons */
    .step-navigation {
        display: flex;
        justify-content: space-between;
        padding: 20px 40px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    .nav-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-btn.primary {
        background: #3b82f6;
        color: white;
    }

    .nav-btn.primary:hover {
        background: #2563eb;
    }

    .nav-btn.secondary {
        background: #e2e8f0;
        color: #64748b;
    }

    .nav-btn.secondary:hover {
        background: #cbd5e1;
    }

    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Results Section */
    .result-card {
        background: white;
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .result-disease {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 16px;
    }

    .result-confidence {
        display: inline-block;
        background: #10b981;
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: 600;
        margin-bottom: 30px;
    }

    .result-recommendations {
        text-align: left;
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        margin-top: 20px;
    }

    .result-recommendations h4 {
        color: #374151;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .result-recommendations ul {
        color: #64748b;
        line-height: 1.6;
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 40px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Quick Selection Buttons */
    .quick-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
    }

    .quick-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center;
    }

    .quick-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .quick-btn i {
        font-size: 1.5rem;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .hero-section h1 {
            font-size: 2rem;
        }

        .wizard-container {
            margin: -20px 10px 20px;
        }

        .step-content {
            padding: 20px;
        }

        .symptom-grid {
            grid-template-columns: 1fr;
        }

        .step-navigation {
            padding: 15px 20px;
        }

        .progress-steps {
            flex-direction: column;
        }

        .step {
            padding: 15px;
        }

        .quick-selection {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="prediction-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <h1><i class='bx bx-brain'></i> AI Disease Prediction</h1>
        <p>Get intelligent health insights in just 3 simple steps</p>
    </div>

    <!-- Wizard Container -->
    <div class="wizard-container">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div>Tell Us About You</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div>Select Symptoms</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div>Get Results</div>
            </div>
        </div>

        <!-- Step 1: Basic Information -->
        <div class="step-content active" id="content1">
            <div class="step-title">Tell Us About Yourself</div>
            <div class="step-description">Help us provide more accurate predictions</div>
            
            <form id="basicInfoForm">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Age</label>
                        <input type="number" id="age" min="1" max="120" 
                               style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;"
                               placeholder="Enter your age">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Gender</label>
                        <select id="gender" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 1px solid #0ea5e9;">
                    <h4 style="color: #0c4a6e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class='bx bx-info-circle'></i>
                        Why do we need this information?
                    </h4>
                    <ul style="color: #64748b; margin: 0; padding-left: 20px;">
                        <li>Age and gender can affect symptom interpretation</li>
                        <li>Helps provide more accurate disease predictions</li>
                        <li>Your information remains completely private</li>
                    </ul>
                </div>
            </form>
        </div>

        <!-- Step 2: Symptom Selection -->
        <div class="step-content" id="content2">
            <div class="step-title">What Symptoms Are You Experiencing?</div>
            <div class="step-description">Select all symptoms that apply to you</div>

            <!-- Quick Selection Options -->
            <div class="quick-selection">
                <button class="quick-btn" onclick="selectCommonCold()">
                    <i class='bx bx-wind'></i>
                    <span>I have a Cold</span>
                </button>
                <button class="quick-btn" onclick="selectFlu()">
                    <i class='bx bx-thermometer'></i>
                    <span>I have Flu-like symptoms</span>
                </button>
                <button class="quick-btn" onclick="selectHeadache()">
                    <i class='bx bx-head'></i>
                    <span>I have a Headache</span>
                </button>
                <button class="quick-btn" onclick="selectStomachIssues()">
                    <i class='bx bx-food-menu'></i>
                    <span>Stomach Problems</span>
                </button>
            </div>

            <!-- Search Symptoms -->
            <div class="symptom-search">
                <i class='bx bx-search'></i>
                <input type="text" placeholder="Search for symptoms..." id="symptomSearchInput">
            </div>

            <!-- Common Symptoms Grid -->
            <div class="common-symptoms">
                <h3>Common Symptoms</h3>
                <div class="symptom-grid" id="symptomGrid">
                    <!-- Symptoms will be populated here -->
                </div>
            </div>

            <!-- Selected Symptoms -->
            <div class="selected-symptoms" id="selectedSymptomsContainer">
                <h3><i class='bx bx-check-circle'></i> Selected Symptoms</h3>
                <div class="selected-list" id="selectedSymptomsList">
                    <!-- Selected symptoms will appear here -->
                </div>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div class="step-content" id="content3">
            <div id="loadingState" class="loading">
                <div class="loading-spinner"></div>
                <h3>Analyzing Your Symptoms...</h3>
                <p>Please wait while our AI processes your information</p>
            </div>

            <div id="resultsState" style="display: none;">
                <div class="result-card">
                    <div class="result-disease" id="predictedDisease">Common Cold</div>
                    <div class="result-confidence" id="confidenceScore">85% confidence</div>
                    
                    <div class="result-recommendations">
                        <h4><i class='bx bx-notepad'></i> Recommendations</h4>
                        <ul id="recommendationsList">
                            <!-- Recommendations will be populated here -->
                        </ul>
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 16px; justify-content: center;">
                        <button class="nav-btn primary" onclick="startOver()">
                            <i class='bx bx-refresh'></i>
                            Check Again
                        </button>
                        <button class="nav-btn secondary" onclick="viewHistory()">
                            <i class='bx bx-history'></i>
                            View History
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="step-navigation">
            <button class="nav-btn secondary" id="prevBtn" onclick="previousStep()" style="visibility: hidden;">
                <i class='bx bx-chevron-left'></i>
                Previous
            </button>
            <button class="nav-btn primary" id="nextBtn" onclick="nextStep()">
                Next
                <i class='bx bx-chevron-right'></i>
            </button>
        </div>
    </div>

    <!-- Recent Predictions -->
    {% if recent_predictions %}
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
            <h3 style="margin: 0 0 16px 0; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                <i class='bx bx-history'></i>
                Recent Predictions
                <button type="button" style="margin-left: auto; padding: 6px 12px; font-size: 14px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;" onclick="deleteAllPredictions()">
                    <i class='bx bx-trash'></i>
                    Delete All
                </button>
            </h3>
            {% for prediction in recent_predictions %}
                <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #3b82f6;" id="prediction-{{ prediction.id }}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: bold; color: #1e293b; font-size: 16px;">{{ prediction.predicted_disease }}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="color: #3b82f6; font-weight: 500; font-size: 14px;">{{ prediction.confidence_score }}% confidence</div>
                            <button type="button" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer;" onclick="deletePrediction({{ prediction.id }})" title="Delete this prediction">
                                <i class='bx bx-trash'></i>
                            </button>
                        </div>
                    </div>
                    <div style="color: #64748b; margin-bottom: 8px; font-size: 14px;">
                        <strong>Symptoms:</strong> {{ prediction.symptoms }}
                    </div>
                    <div style="color: #94a3b8; font-size: 12px;">{{ prediction.created_at|date:"M d, Y - g:i A" }}</div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<form id="predictionForm" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="symptoms" id="symptomsInput">
    <input type="hidden" name="age" id="ageInput">
    <input type="hidden" name="gender" id="genderInput">
</form>

<script>
// Simple symptom database
const commonSymptoms = [
    { name: 'Fever', icon: 'bx-thermometer', description: 'Body temperature above normal' },
    { name: 'Cough', icon: 'bx-wind', description: 'Persistent coughing' },
    { name: 'Headache', icon: 'bx-head', description: 'Pain in head or neck area' },
    { name: 'Sore Throat', icon: 'bx-mouth', description: 'Pain or irritation in throat' },
    { name: 'Runny Nose', icon: 'bx-droplet', description: 'Nasal discharge' },
    { name: 'Fatigue', icon: 'bx-tired', description: 'Feeling very tired or weak' },
    { name: 'Nausea', icon: 'bx-dizzy', description: 'Feeling sick to stomach' },
    { name: 'Vomiting', icon: 'bx-sad', description: 'Throwing up' },
    { name: 'Diarrhea', icon: 'bx-food-menu', description: 'Loose or liquid bowel movements' },
    { name: 'Muscle Aches', icon: 'bx-body', description: 'Pain in muscles' },
    { name: 'Shortness of Breath', icon: 'bx-wind', description: 'Difficulty breathing' },
    { name: 'Chest Pain', icon: 'bx-heart', description: 'Pain in chest area' },
    { name: 'Dizziness', icon: 'bx-dizzy', description: 'Feeling lightheaded' },
    { name: 'Loss of Appetite', icon: 'bx-food-menu', description: 'Not wanting to eat' },
    { name: 'Skin Rash', icon: 'bx-band-aid', description: 'Red or irritated skin' },
    { name: 'Joint Pain', icon: 'bx-body', description: 'Pain in joints' }
];

let currentStep = 1;
let selectedSymptoms = [];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    populateSymptomGrid();
    setupSearchFunctionality();
});

// Populate symptom grid
function populateSymptomGrid() {
    const grid = document.getElementById('symptomGrid');
    grid.innerHTML = '';
    
    commonSymptoms.forEach((symptom, index) => {
        const card = document.createElement('div');
        card.className = 'symptom-card';
        card.onclick = () => toggleSymptom(symptom.name);
        card.innerHTML = `
            <i class='bx ${symptom.icon} symptom-icon'></i>
            <div class="symptom-name">${symptom.name}</div>
            <div class="symptom-description">${symptom.description}</div>
        `;
        grid.appendChild(card);
    });
}

// Setup search functionality
function setupSearchFunctionality() {
    const searchInput = document.getElementById('symptomSearchInput');
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.symptom-card');
        
        cards.forEach(card => {
            const symptomName = card.querySelector('.symptom-name').textContent.toLowerCase();
            const symptomDesc = card.querySelector('.symptom-description').textContent.toLowerCase();
            
            if (symptomName.includes(searchTerm) || symptomDesc.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
}

// Toggle symptom selection
function toggleSymptom(symptomName) {
    const index = selectedSymptoms.indexOf(symptomName);
    
    if (index > -1) {
        selectedSymptoms.splice(index, 1);
    } else {
        selectedSymptoms.push(symptomName);
    }
    
    updateSymptomDisplay();
    updateSelectedList();
}

// Update symptom card display
function updateSymptomDisplay() {
    const cards = document.querySelectorAll('.symptom-card');
    cards.forEach(card => {
        const symptomName = card.querySelector('.symptom-name').textContent;
        if (selectedSymptoms.includes(symptomName)) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
}

// Update selected symptoms list
function updateSelectedList() {
    const container = document.getElementById('selectedSymptomsContainer');
    const list = document.getElementById('selectedSymptomsList');
    
    if (selectedSymptoms.length === 0) {
        container.classList.remove('show');
        return;
    }
    
    container.classList.add('show');
    list.innerHTML = '';
    
    selectedSymptoms.forEach(symptom => {
        const item = document.createElement('div');
        item.className = 'selected-item';
        item.innerHTML = `
            ${symptom}
            <span class="remove" onclick="removeSymptom('${symptom}')">Ã—</span>
        `;
        list.appendChild(item);
    });
}

// Remove symptom
function removeSymptom(symptomName) {
    toggleSymptom(symptomName);
}

// Quick selection functions
function selectCommonCold() {
    selectedSymptoms = ['Runny Nose', 'Cough', 'Sore Throat', 'Fatigue'];
    updateSymptomDisplay();
    updateSelectedList();
}

function selectFlu() {
    selectedSymptoms = ['Fever', 'Cough', 'Muscle Aches', 'Fatigue', 'Headache'];
    updateSymptomDisplay();
    updateSelectedList();
}

function selectHeadache() {
    selectedSymptoms = ['Headache'];
    updateSymptomDisplay();
    updateSelectedList();
}

function selectStomachIssues() {
    selectedSymptoms = ['Nausea', 'Vomiting', 'Diarrhea', 'Loss of Appetite'];
    updateSymptomDisplay();
    updateSelectedList();
}

// Navigation functions
function nextStep() {
    if (currentStep === 1) {
        // Validate basic info (optional)
        currentStep = 2;
        showStep(2);
    } else if (currentStep === 2) {
        if (selectedSymptoms.length === 0) {
            alert('Please select at least one symptom.');
            return;
        }
        currentStep = 3;
        showStep(3);
        submitPrediction();
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

function showStep(step) {
    // Update step indicators
    document.querySelectorAll('.step').forEach((el, index) => {
        el.classList.remove('active', 'completed');
        if (index + 1 < step) {
            el.classList.add('completed');
        } else if (index + 1 === step) {
            el.classList.add('active');
        }
    });
    
    // Update step content
    document.querySelectorAll('.step-content').forEach((el, index) => {
        el.classList.remove('active');
        if (index + 1 === step) {
            el.classList.add('active');
        }
    });
    
    // Update navigation buttons
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    if (step === 1) {
        prevBtn.style.visibility = 'hidden';
        nextBtn.innerHTML = 'Next <i class="bx bx-chevron-right"></i>';
    } else if (step === 2) {
        prevBtn.style.visibility = 'visible';
        nextBtn.innerHTML = 'Get Prediction <i class="bx bx-brain"></i>';
    } else if (step === 3) {
        prevBtn.style.visibility = 'hidden';
        nextBtn.style.display = 'none';
    }
}

// Submit prediction
function submitPrediction() {
    const loadingState = document.getElementById('loadingState');
    const resultsState = document.getElementById('resultsState');
    
    loadingState.style.display = 'block';
    resultsState.style.display = 'none';
    
    // Prepare form data
    const age = document.getElementById('age').value;
    const gender = document.getElementById('gender').value;
    
    // Create form data with symptoms as multiple values
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Add each symptom separately (as the view expects getlist)
    selectedSymptoms.forEach(symptom => {
        formData.append('symptoms', symptom);
    });
    
    if (age) formData.append('age', age);
    if (gender) formData.append('gender', gender);
    
    // Submit form via AJAX
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        loadingState.style.display = 'none';
        resultsState.style.display = 'block';
        
        if (data.success) {
            document.getElementById('predictedDisease').textContent = data.disease || 'Unknown';
            document.getElementById('confidenceScore').textContent = (data.confidence || 0) + '% confidence';
            
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            const recommendations = data.recommendations || [
                'Rest and get plenty of sleep',
                'Stay hydrated by drinking fluids',
                'Consult a healthcare provider if symptoms worsen',
                'Monitor your symptoms closely'
            ];
            
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsList.appendChild(li);
            });
        } else {
            throw new Error(data.error || 'Prediction failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loadingState.style.display = 'none';
        resultsState.style.display = 'block';
        document.getElementById('predictedDisease').textContent = 'Error occurred';
        document.getElementById('confidenceScore').textContent = 'Please try again';
        
        const recommendationsList = document.getElementById('recommendationsList');
        recommendationsList.innerHTML = '';
        const errorRecommendations = [
            'Please check your internet connection',
            'Try selecting different symptoms',
            'Make sure you have selected at least one symptom',
            'Contact support if the problem persists'
        ];
        
        errorRecommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recommendationsList.appendChild(li);
        });
    });
}

// Utility functions
function startOver() {
    currentStep = 1;
    selectedSymptoms = [];
    document.getElementById('age').value = '';
    document.getElementById('gender').value = '';
    updateSymptomDisplay();
    updateSelectedList();
    showStep(1);
    document.getElementById('nextBtn').style.display = 'flex';
}

function viewHistory() {
    // Scroll to history section if it exists
    const historySection = document.querySelector('.recent-predictions');
    if (historySection) {
        historySection.scrollIntoView({ behavior: 'smooth' });
    }
}

// Delete prediction functions (same as before)
function deletePrediction(predictionId) {
    if (confirm('Are you sure you want to delete this prediction?')) {
        fetch('{% url "ml_prediction:delete_prediction" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'prediction_id': predictionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const predictionElement = document.getElementById('prediction-' + predictionId);
                if (predictionElement) {
                    predictionElement.remove();
                }
                showMessage('Prediction deleted successfully', 'success');
            } else {
                showMessage(data.error || 'Failed to delete prediction', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while deleting the prediction', 'error');
        });
    }
}

function deleteAllPredictions() {
    if (confirm('Are you sure you want to delete ALL your predictions? This action cannot be undone.')) {
        fetch('{% url "ml_prediction:delete_all_predictions" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const recentPredictionsSection = document.querySelector('.recent-predictions');
                if (recentPredictionsSection) {
                    recentPredictionsSection.style.display = 'none';
                }
                showMessage('All predictions deleted successfully', 'success');
            } else {
                showMessage(data.error || 'Failed to delete predictions', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while deleting predictions', 'error');
        });
    }
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        ${type === 'success' ? 'background: #10b981;' : 'background: #ef4444;'}
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 300);
    }, 3000);
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>

{% endblock %}